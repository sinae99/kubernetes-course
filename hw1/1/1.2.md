# A – Commands

## 1. Create 2 isolated processes with NET namespaces

Open **two different terminals**:

```bash
sudo unshare --net --fork bash
echo "PID = $$"
ip addr       # should show only 'lo'
```

This creates:

- an isolated **network namespace**
- a `bash` shell inside that namespace

Save the two PIDs: `<PID1>` and `<PID2>`.

---

## 2. Create a Linux bridge on the host (virtual switch)

In the **host terminal**:

```bash
sudo ip link add br0 type bridge
sudo ip link set br0 up
sudo ip addr add 10.200.0.254/24 dev br0
ip addr show br0
```

`br0` acts like Docker’s `docker0` bridge.

---

## 3. Connect namespace 1 to `br0`

On the **host**:

```bash
sudo ip link add veth-ns1 type veth peer name veth-br1
sudo ip link set veth-ns1 netns <PID1>
sudo ip link set veth-br1 master br0
sudo ip link set veth-br1 up
```

Inside **Namespace 1**:

```bash
ip link set veth-ns1 up
ip addr add 10.200.0.1/24 dev veth-ns1
ip link set lo up
ip addr
```

---

## 4. Connect namespace 2 to `br0`

On the **host**:

```bash
sudo ip link add veth-ns2 type veth peer name veth-br2
sudo ip link set veth-ns2 netns <PID2>
sudo ip link set veth-br2 master br0
sudo ip link set veth-br2 up
```

Inside **Namespace 2**:

```bash
ip link set veth-ns2 up
ip addr add 10.200.0.2/24 dev veth-ns2
ip link set lo up
ip addr
```

---

## 5. Test Connectivity

From **Namespace 1**:

```bash
ping 10.200.0.2
```

You should receive ICMP replies.

---

## 6. (Important) Fix on systems where ping fails

Many VPS/cloud hosts redirect bridge traffic into iptables/arptables.  
If ping does not work, run on the **host**:

```bash
sudo sysctl -w net.bridge.bridge-nf-call-iptables=0
sudo sysctl -w net.bridge.bridge-nf-call-arptables=0
sudo sysctl -w net.bridge.bridge-nf-call-ip6tables=0
```

This allows ARP + ICMP to pass through the bridge.

---

# B – Notes

## Concept: Container Networking

A minimal container network includes:

| Component | Purpose |
|----------|----------|
| **Network namespace** | Isolated network stack per process |
| **veth pair** | Virtual cable connecting namespaces |
| **bridge (br0)** | Virtual switch for L2 connectivity |
| **IP assignment** | Gives each namespace an address |

---

## How Data Flows

```
NS1 (veth-ns1) ↔ veth-br1 ↔ br0 ↔ veth-br2 ↔ veth-ns2 (NS2)
```

- veth pairs work like cables  
- bridge acts like a switch  
- same subnet = no routing required  
- ping uses ARP + ICMP normally  

---

## Summary

You manually recreated the essential parts of container networking:

- `unshare` → creates network namespaces  
- `veth` → connects isolated namespaces  
- `bridge` → provides shared Layer-2  
- `ip addr` → configure addresses  
- `ping` → verify connectivity  

This is how Docker and Kubernetes CNI connect containers/pods on a node.








# Steps

1. Open 3 terminals:
   - Terminal 1 → Host
   - Terminal 2 → Namespace 1 (NS1)
   - Terminal 3 → Namespace 2 (NS2)

2. In NS1 terminal:
   - Run: `sudo unshare --net --fork bash`
   - Show PID: `echo PID = $$`

3. In NS2 terminal:
   - Run: `sudo unshare --net --fork bash`
   - Show PID: `echo PID = $$`

4. On the Host terminal:
   - Create bridge: `ip link add br0 type bridge`
   - Bring it up: `ip link set br0 up`
   - Assign IP: `ip addr add 10.200.0.254/24 dev br0`

5. Connect NS1 to the bridge (host terminal):
   - Create veth pair: `ip link add veth-ns1 type veth peer name veth-br1`
   - Move one end to NS1: `ip link set veth-ns1 netns <PID1>`
   - Attach other end to br0: `ip link set veth-br1 master br0; ip link set veth-br1 up`

6. Configure NS1 (NS1 terminal):
   - `ip link set veth-ns1 up`
   - `ip addr add 10.200.0.1/24 dev veth-ns1`
   - `ip link set lo up`

7. Connect NS2 to the bridge (host terminal):
   - Create veth pair: `ip link add veth-ns2 type veth peer name veth-br2`
   - Move one end to NS2: `ip link set veth-ns2 netns <PID2>`
   - Attach other end to br0: `ip link set veth-br2 master br0; ip link set veth-br2 up`

8. Configure NS2 (NS2 terminal):
   - `ip link set veth-ns2 up`
   - `ip addr add 10.200.0.2/24 dev veth-ns2`
   - `ip link set lo up`

9. (If ping fails) Fix bridge filtering on host:
   - `sysctl -w net.bridge.bridge-nf-call-iptables=0`
   - `sysctl -w net.bridge.bridge-nf-call-arptables=0`
   - `sysctl -w net.bridge.bridge-nf-call-ip6tables=0`

10. Test connectivity:
    - From NS1: `ping 10.200.0.2`

11. Explain the flow:
    - veth-ns1 ↔ veth-br1 ↔ br0 ↔ veth-br2 ↔ veth-ns2







